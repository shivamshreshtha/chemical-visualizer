<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Chemical Equipment Visualizer</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body{ font-family: Arial; background:#f4f6f8; padding:40px; }
    h1{ text-align:center; margin:0; }
    .sub{ text-align:center; color:#0a7a2f; margin: 6px 0 18px; font-weight:700; }

    .box{ background:white; padding:20px; max-width:1050px; margin:auto; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:10px; }

    input[type="text"]{ width:520px; padding:10px; border:1px solid #ccc; border-radius:8px; }
    input[type="file"]{ padding:10px; }

    button{ padding:10px 16px; background:#28a745; border:none; color:white; cursor:pointer; border-radius:8px; }
    button:hover{ background:#218838; }
    button.secondary{ background:#007bff; }
    button.secondary:hover{ background:#005dc1; }

    #status{ margin-top:8px; font-weight:700; }
    #status.ok{ color:#0a7a2f; }
    #status.bad{ color:#c00; }

    table{ width:100%; border-collapse:collapse; margin-top:16px; }
    th,td{ border:1px solid #ddd; padding:8px; text-align:center; }
    th{ background:#007bff; color:white; }

    canvas{ margin-top:20px; background:#fff; border:1px solid #eee; border-radius:8px; padding:10px; }

    .history{ margin-top:18px; padding:12px; border:1px solid #eee; border-radius:10px; background:#fafafa; }
    .history-item{ display:flex; justify-content:space-between; align-items:center; gap:12px; padding:10px; border-bottom:1px solid #eee; }
    .history-item:last-child{ border-bottom:none; }
    .muted{ color:#666; font-size:13px; }
    pre{ background:#111; color:#0f0; padding:12px; border-radius:10px; overflow:auto; }
  </style>
</head>

<body>
  <h1>Chemical Equipment Parameter Visualizer</h1>
  <div class="sub">FINAL VERSION ✅ (Refresh History + Download PDF buttons)</div>

  <div class="box">

    <div class="row">
      <label><b>Token:</b></label>
      <input id="tokenInput" type="text" placeholder="Paste token here" value="1fa75a54b83c237bf83e4565d36917b6d86895b8" />
      <button class="secondary" type="button" onclick="testToken()">Test Token</button>
      <button class="secondary" type="button" onclick="loadHistory()">Refresh History</button>
    </div>

    <div class="row">
      <input type="file" id="csvFile" accept=".csv" />
      <button type="button" onclick="uploadCSV()">Upload CSV</button>
    </div>

    <div id="status"></div>

    <div id="result"></div>

    <canvas id="flowChart"></canvas>
    <canvas id="typeChart"></canvas>

    <div class="history">
      <h3>History (last 5 uploads)</h3>
      <div id="historyBox" class="muted">Click “Refresh History”</div>
    </div>

    <h3>Raw Response (debug)</h3>
    <pre id="raw"></pre>

  </div>

<script>
  const API_UPLOAD  = "http://127.0.0.1:8000/api/upload/";
  const API_HISTORY = "http://127.0.0.1:8000/api/history/";
  const API_REPORT  = (id) => `http://127.0.0.1:8000/api/report/${id}/`;

  let flowChart = null;
  let typeChart = null;

  function setStatus(msg, ok=true){
    const el = document.getElementById("status");
    el.className = ok ? "ok" : "bad";
    el.textContent = msg;
  }

  function getToken(){
    return document.getElementById("tokenInput").value.trim();
  }

  function authHeaders(){
    const token = getToken();
    return { "Authorization": `Token ${token}`, "Accept": "application/json" };
  }

  async function testToken(){
    setStatus("Testing token...", true);
    document.getElementById("raw").textContent = "";

    try{
      const res = await fetch(API_HISTORY, { method:"GET", mode:"cors", headers: authHeaders() });
      const text = await res.text();
      document.getElementById("raw").textContent = `HTTP ${res.status}\n\n${text}`;

      if(!res.ok){
        setStatus(`❌ Token test failed (HTTP ${res.status})`, false);
        return;
      }

      setStatus("✅ Token OK. History endpoint reachable.", true);
    }catch(err){
      console.error(err);
      setStatus("❌ Token test error: " + err.message, false);
    }
  }

  async function uploadCSV(){
    const file = document.getElementById("csvFile").files[0];
    if(!file) return alert("Please select a CSV file");

    setStatus("Uploading CSV...", true);
    document.getElementById("raw").textContent = "";
    document.getElementById("result").innerHTML = "";

    const formData = new FormData();
    formData.append("file", file);

    try{
      const res = await fetch(API_UPLOAD, {
        method: "POST",
        mode: "cors",
        headers: authHeaders(),
        body: formData
      });

      const text = await res.text();
      document.getElementById("raw").textContent = `HTTP ${res.status}\n\n${text}`;

      let data = {};
      try{ data = JSON.parse(text); }catch(e){}

      if(!res.ok){
        const msg = data.detail || data.error || text || `HTTP ${res.status}`;
        setStatus(`❌ Upload failed (HTTP ${res.status}): ${msg}`, false);
        return;
      }

      setStatus("✅ Upload OK", true);
      renderAll(data);
      await loadHistory();

    }catch(err){
      console.error(err);
      setStatus("❌ Upload error: " + err.message, false);
    }
  }

  function renderAll(data){
    showTableAndStats(data);
    drawCharts(data);
  }

  function showTableAndStats(data){
    let html = `<h3>Rows: ${data.rows}</h3>`;

    html += "<table><tr>";
    (data.columns || []).forEach(col => html += `<th>${col}</th>`);
    html += "</tr>";

    (data.preview || []).forEach(row => {
      html += "<tr>";
      row.forEach(cell => html += `<td>${cell}</td>`);
      html += "</tr>";
    });
    html += "</table>";

    if(data.averages){
      html += `
        <h3>Averages</h3>
        <ul>
          <li>Flowrate: ${Number(data.averages.flowrate).toFixed(2)}</li>
          <li>Pressure: ${Number(data.averages.pressure).toFixed(2)}</li>
          <li>Temperature: ${Number(data.averages.temperature).toFixed(2)}</li>
        </ul>
      `;
    }

    if(data.equipment_distribution){
      html += "<h3>Equipment Distribution</h3><ul>";
      Object.keys(data.equipment_distribution).forEach(k => {
        html += `<li>${k}: ${data.equipment_distribution[k]}</li>`;
      });
      html += "</ul>";
    }

    document.getElementById("result").innerHTML = html;
  }

  function drawCharts(data){
    if(flowChart) flowChart.destroy();
    if(typeChart) typeChart.destroy();

    const names = (data.preview || []).map(r => r[0]);
    const flowrates = (data.preview || []).map(r => r[2]);

    flowChart = new Chart(document.getElementById("flowChart"), {
      type: "bar",
      data: { labels: names, datasets: [{ label: "Flowrate", data: flowrates }] }
    });

    const types = Object.keys(data.equipment_distribution || {});
    const counts = Object.values(data.equipment_distribution || {});

    typeChart = new Chart(document.getElementById("typeChart"), {
      type: "pie",
      data: { labels: types, datasets: [{ label: "Equipment Types", data: counts }] }
    });
  }

  async function loadHistory(){
    const box = document.getElementById("historyBox");
    box.textContent = "Loading...";

    try{
      const res = await fetch(API_HISTORY, { method:"GET", mode:"cors", headers: authHeaders() });
      const text = await res.text();
      document.getElementById("raw").textContent = `HTTP ${res.status}\n\n${text}`;

      if(!res.ok){
        box.textContent = "❌ History failed. (Check token/backend)";
        setStatus(`❌ History failed (HTTP ${res.status})`, false);
        return;
      }

      const list = JSON.parse(text);
      if(!list.length){
        box.textContent = "No uploads found. Upload a CSV first.";
        return;
      }

      box.innerHTML = list.map(item => `
        <div class="history-item">
          <div>
            <div><b>ID:</b> ${item.id} | <b>File:</b> ${item.filename} | <b>Rows:</b> ${item.rows}</div>
            <div class="muted">${item.created_at}</div>
          </div>
          <div>
            <button class="secondary" onclick="downloadPDF(${item.id})">Download PDF</button>
          </div>
        </div>
      `).join("");

      setStatus("✅ History loaded", true);

    }catch(err){
      console.error(err);
      box.textContent = "❌ Failed to fetch history: " + err.message;
      setStatus("❌ Failed to fetch history: " + err.message, false);
    }
  }

  async function downloadPDF(id){
    setStatus(`Preparing PDF for ID ${id}...`, true);
    try{
      const res = await fetch(API_REPORT(id), { method:"GET", mode:"cors", headers: authHeaders() });
      if(!res.ok){
        const t = await res.text();
        console.error(t);
        setStatus(`❌ PDF failed (HTTP ${res.status})`, false);
        alert("PDF download failed: " + res.status);
        return;
      }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `report_${id}.pdf`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      setStatus("✅ PDF downloaded", true);
    }catch(err){
      console.error(err);
      setStatus("❌ PDF download error: " + err.message, false);
    }
  }
</script>

</body>
</html>
